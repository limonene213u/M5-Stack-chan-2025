# スタックチャン 通信エディション 2025

日本語 | [English](README_en.md)

スタックチャンの通信機能に特化した日本語対応ファームウェアです。WiFi複数AP対応、APモード切り替え、Bluetooth通信によって外部からメッセージを送信し、Avatar表示機能を含む完全なstack-chan実装です。

![Stack-chan Communication](docs/images/stack-chan-demo.png)

## ✨ 主要機能

### 🌐 通信機能
- **WiFi複数AP対応**: 最大10個のWiFiネットワークを登録・自動接続
- **APモード切り替え**: スタックチャン自体がWiFiアクセスポイントになる
- **自動フォールバック**: 全WiFi接続失敗時に自動でAPモードに切り替え
- **WebUI WiFi管理**: ブラウザからWiFi設定の追加・削除・切り替え
- **Bluetooth通信**: シリアル通信でのメッセージ受信

### 🎨 表示・Avatar機能
- **🗾 日本語完全対応**: M5GFX内蔵日本語フォント・文字化け解決済み
- **😊 Avatar表情システム**: リアルタイム表情変更（Happy、Sleepy、Doubt等）
- **📱 WebUI操作**: ブラウザからメッセージ送信・表情変更
- **🔊 音声準備**: 将来のTTS/音声認識機能に対応した設計

### ⚡ 技術的特徴
- **StackchanSystemConfig対応**: 公式stack-chan設定ファイル完全対応
- **FreeRTOS最適化**: Avatar機能との安定した共存
- **拡張性重視**: ChatGPT API等の高度な機能への発展基盤

## 📚 技術参考・比較

### 基盤実装
- **元実装**: TakaoAkaki/stack-chan-tester
- **参考事例**: M5Unified_StackChan_ChatGPT
- **発展方向**: 会話AI機能への拡張

### 実装比較表

| 機能 | 本実装 | ChatGPT版 | 元実装 |
|------|-------|---------|--------|
| WiFi管理 | ✅ 複数AP | ✅ SmartConfig | ❌ 単一のみ |
| Avatar表示 | ✅ 基本機能 | ✅ 表情連動 | ✅ 基本 |
| 日本語対応 | ✅ M5GFX内蔵 | ✅ efontJA_16 | ❌ 制限 |
| WebUI | ✅ 設定管理 | ✅ チャット | ❌ なし |
| 音声機能 | ⏳ 準備中 | ✅ TTS+認識 | ❌ なし |
| AI機能 | ⏳ 将来対応 | ✅ ChatGPT | ❌ なし |

## 🎯 対応デバイス

- **M5Stack Basic (Grey)** ✅ **推奨・開発基準**
- M5Stack Core2 ✅ **動作確認済み**
- M5Stack CoreS3 ✅ 
- M5Stack Fire ✅
- M5Stack Core1 (一部制限あり)

## ⚙️ セットアップ・使い方

### 1. WiFi設定

`data/yaml/SC_BasicConfig.yaml`ファイルでWiFi設定を行います：

```yaml
wifi:
  # WiFiクライアント設定（最大10個まで登録可能）
  networks:
    - ssid: "Home-WiFi"         # 自宅WiFi
      password: "password123"
      priority: 1               # 優先度（1が最高）
    - ssid: "Office-WiFi"       # オフィスWiFi
      password: "office456" 
      priority: 2
    - ssid: "Mobile-Hotspot"    # モバイルホットスポット
      password: "mobile789"
      priority: 3
  
  # アクセスポイントモード設定
  ap_mode:
    enable: false               # 起動時のAPモード有効化
    ssid: "Stack-chan"          # APのSSID
    password: "Stack-chan-88"   # APのパスワード
    auto_fallback: true         # クライアント接続失敗時の自動APモード切替
```

### 2. ビルドと書き込み

```bash
# M5Stack Basic (Grey) - 推奨
pio run -e m5stack-grey

# M5Stack Core2
pio run -e m5stack-core2

# 書き込み (デバイスに応じて環境名を変更)
pio run -e m5stack-grey -t upload

# ファイルシステム書き込み（設定ファイル用）
pio run -e m5stack-grey -t uploadfs
```

## 📱 使い方

### WiFi接続

1. **自動接続**: 起動時に設定されたWiFiネットワークに優先度順で自動接続
2. **APモード**: 全接続失敗時は自動でAPモード（SSID: Stack-chan, PASS: Stack-chan-88）
3. **手動切り替え**: Webインターフェースまたはボタンでモード切り替え可能

### Webインターフェース

接続成功後、シリアルモニターまたは画面に表示されるIPアドレスにブラウザでアクセス。

#### 📋 制御パネル機能

- **メッセージ送信**: テキスト入力してスタックチャンに表示
- **表情変更**: 普通・嬉しい・眠い・疑問の4種類
- **WiFi管理**: ネットワークスキャン・追加・接続・モード切り替え
- **システム状態**: リアルタイム状態表示

#### 🔌 REST API

現在のシンプル版で利用可能なAPIエンドポイント：

##### 表情サイクル変更

```http
GET /api/expression
```

レスポンス: `Expression changed to: 嬉しい`

##### 色テーマサイクル変更

```http
GET /api/color
```

レスポンス: `Color changed to: 青系`

##### 特定色テーマ設定

```http
GET /api/setcolor?index=0
```

パラメータ:

- `index`: 色テーマ番号 (0-5)
  - `0`: 標準色
  - `1`: 青系
  - `2`: 緑系  
  - `3`: 赤系
  - `4`: 紫系
  - `5`: オレンジ系

レスポンス: `Color set to: 赤系`

##### 表情とセリフの同時設定

```http
GET /api/set?expression=1&speech=こんにちは！
```

パラメータ:

- `expression`: 表情番号 (0-3)
  - `0`: 普通 (Neutral)
  - `1`: 嬉しい (Happy)
  - `2`: 眠い (Sleepy)
  - `3`: 困った (Doubt)
- `speech`: 表示するセリフ（日本語対応、URLエンコード推奨）

レスポンス: `表情: 嬉しい, セリフ: "こんにちは！"`

##### セリフクリア

```http
GET /api/set?speech=
```

レスポンス: `セリフ: ""`

### APIの使用例

#### cURLでの操作例

```bash
# 表情を嬉しいにしてメッセージを表示
curl "http://192.168.1.100/api/set?expression=1&speech=Hello%20World"

# 色を赤系に変更
curl "http://192.168.1.100/api/setcolor?index=3"

# セリフをクリア
curl "http://192.168.1.100/api/set?speech="
```

#### JavaScriptでの操作例

```javascript
// 表情とセリフを設定
fetch('/api/set?expression=1&speech=' + encodeURIComponent('こんにちは！'))
  .then(response => response.text())
  .then(data => console.log(data));

// 色をランダムに変更
const colorIndex = Math.floor(Math.random() * 6);
fetch(`/api/setcolor?index=${colorIndex}`)
  .then(response => response.text())
  .then(data => console.log(data));
```

#### Pythonでの操作例

```python
import requests
import urllib.parse

# Stack-chanのIPアドレス
base_url = "http://192.168.1.100"

# 表情とセリフを設定
speech = "Pythonからこんにちは！"
encoded_speech = urllib.parse.quote(speech)
response = requests.get(f"{base_url}/api/set?expression=1&speech={encoded_speech}")
print(response.text)

# 色を青系に変更
response = requests.get(f"{base_url}/api/setcolor?index=1")
print(response.text)
```

### セリフ自動ループ機能

- ユーザーが設定したセリフは30秒後に自動的にクリアされます
- 設定ファイル（`simple_wifi_config.h`）にランダムセリフが登録されている場合、自動的にループ表示されます
- ランダムセリフが無効な場合は「スタックちゃん」に戻ります

### ボタン操作

- **ボタンA**: 表情サイクル変更（普通→嬉しい→眠い→困った）
- **ボタンB**: WiFi再接続
- **ボタンC**: IP アドレス表示

### WebUI操作

ブラウザでStack-chanのIPアドレスにアクセスすると、以下の機能が利用できます：

- **表情とセリフの設定**: プルダウンで表情を選択し、テキストでセリフを入力
- **クイック操作**: 表情サイクル、色変更、セリフクリアボタン
- **色テーマ選択**: 6種類の色テーマを直接選択
- **システム状態**: メモリ使用量、稼働時間、WiFi情報の表示

## 設定カスタマイズ

### WiFi設定変更

`src/simple_wifi_config.h` でWiFi設定を変更できます：

```cpp
const WiFiCredentials wifi_networks[] = {
  {"あなたのSSID", "パスワード", 1},
  {"予備のSSID", "パスワード", 2}, 
  {nullptr, nullptr, 0}  // 終端マーカー
};
```

### ランダムセリフ設定

同じファイルでランダムセリフを設定できます：

```cpp
const char* random_speeches[] = {
  "カスタムセリフ1",
  "カスタムセリフ2",
  "お好みのセリフ",
  nullptr  // 終端マーカー
};
```

ランダムセリフを無効にする場合：

```cpp
const char* random_speeches[] = {
  nullptr  // 終端マーカーのみ
};
```

## トラブルシューティング

### WiFi接続できない

1. SSIDとパスワードを確認
2. 2.4GHz帯のWiFiを使用
3. シリアルモニターでエラー確認

### WebUIにアクセスできない

1. WiFi接続を確認
2. シリアルモニターでIPアドレス確認
3. ブラウザのキャッシュをクリア

### メッセージが表示されない

1. URLエンコードが正しいか確認
2. API応答ステータスを確認
3. シリアルモニターでログ確認

## ライセンス

MIT License

## 作者

Based on TakaoAkaki's stack-chan-tester